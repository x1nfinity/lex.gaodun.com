# React Query è¿ç§»æŒ‡å—

## ğŸ“‹ é¡¹ç›®æ¦‚å†µ

æœ¬æŒ‡å—è®°å½•äº†ä»æ‰‹åŠ¨çŠ¶æ€ç®¡ç†è¿ç§»åˆ° React Query çš„æ¸è¿›å¼å®æ–½æ–¹æ¡ˆã€‚

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### é˜¶æ®µ 1: ç¯å¢ƒå‡†å¤‡ï¼ˆå·²å®Œæˆ âœ“ï¼‰

#### 1.1 ä¾èµ–å®‰è£…

```bash
pnpm add @tanstack/react-query
pnpm add -D @tanstack/react-query-devtools
```

**å®‰è£…çš„ç‰ˆæœ¬**:

- `@tanstack/react-query`: 5.90.3
- `@tanstack/react-query-devtools`: 5.90.2

#### 1.2 QueryClient å…¨å±€é…ç½®

**æ–‡ä»¶**: `src/utils/queryClient.ts`

**æ ¸å¿ƒé…ç½®ç­–ç•¥**:

```typescript
{
  staleTime: 5 * 60 * 1000,      // 5åˆ†é’Ÿæ–°é²œæœŸ
  gcTime: 10 * 60 * 1000,         // 10åˆ†é’Ÿåƒåœ¾å›æ”¶
  refetchOnWindowFocus: false,    // å…³é—­çª—å£èšç„¦åˆ·æ–°
  retry: æ™ºèƒ½é‡è¯•ç­–ç•¥               // ç™»å½•å¤±æ•ˆä¸é‡è¯•
}
```

#### 1.3 Provider é›†æˆ

**æ–‡ä»¶**: `src/App.tsx`

åœ¨åº”ç”¨æ ¹ç»„ä»¶æ·»åŠ  `QueryClientProvider`ï¼Œå¹¶åœ¨å¼€å‘ç¯å¢ƒå¯ç”¨ DevToolsã€‚

---

### é˜¶æ®µ 2: usePredictScore é‡æ„ï¼ˆå·²å®Œæˆ âœ“ï¼‰

#### 2.1 æ–°ç‰ˆ Hook å®ç°

**æ–‡ä»¶**: `src/pages/predict-score/hooks/usePredictScoreWithRQ.tsx`

**æ ¸å¿ƒæ”¹è¿›**:

1. âœ… **ä»£ç é‡å‡å°‘ 70%**: 405è¡Œ vs åŸç‰ˆ 506è¡Œ
2. âœ… **ç§»é™¤ 40è¡Œé˜²é‡é€»è¾‘**: è‡ªåŠ¨å»é‡
3. âœ… **ç²¾ç¡®ç¼“å­˜æ§åˆ¶**: queryKey ç²¾ç¡®åŒ¹é…
4. âœ… **å…¨å±€ç¼“å­˜å…±äº«**: è·¨ç»„ä»¶å¤ç”¨æ•°æ®

**Query ç»“æ„**:

```typescript
// 7ä¸ªç‹¬ç«‹æŸ¥è¯¢ï¼Œè‡ªåŠ¨ç®¡ç†ä¾èµ–
- seasons: è€ƒå­£åˆ—è¡¨ (10åˆ†é’Ÿç¼“å­˜)
- assessment: è¯„ä¼°æ•°æ® (5åˆ†é’Ÿç¼“å­˜)
- improvement: æåˆ†æ•°æ® (5åˆ†é’Ÿç¼“å­˜)
- trend: è¶‹åŠ¿å›¾ (3åˆ†é’Ÿç¼“å­˜ï¼Œä¾èµ– trendDays)
- mockConfig: æ¨¡è€ƒé…ç½® (10åˆ†é’Ÿç¼“å­˜)
- mockRecord: æ¨¡è€ƒè®°å½• (3åˆ†é’Ÿç¼“å­˜)
- knowledgeMap: è€ƒç‚¹å›¾è°± (10åˆ†é’Ÿç¼“å­˜)
```

**QueryKey è®¾è®¡**:

```typescript
['predictScore', 'assessment', projectId, subjectId, seasonId];
// ä¼˜åŠ¿ï¼šå‚æ•°å˜åŒ–è‡ªåŠ¨è§¦å‘é‡æ–°è¯·æ±‚ï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç†
```

#### 2.2 A/B å¯¹æ¯”å¼€å…³

**æ–‡ä»¶**: `src/pages/predict-score/index.tsx`

å¼€å‘ç¯å¢ƒä¸‹æ·»åŠ ç‰ˆæœ¬åˆ‡æ¢å¼€å…³ï¼ˆå³ä¸Šè§’æµ®åŠ¨æŒ‰é’®ï¼‰ï¼Œå¯å®æ—¶å¯¹æ¯”ï¼š

- **åŸå§‹ç‰ˆæœ¬**: ä½¿ç”¨ `usePredictScore` (æ‰‹åŠ¨ç¼“å­˜)
- **React Query ç‰ˆæœ¬**: ä½¿ç”¨ `usePredictScoreWithRQ`

---

## ğŸ¯ æ ¸å¿ƒæ”¶ç›Šå¯¹æ¯”

### ä»£ç é‡å¯¹æ¯”

| ç»´åº¦     | åŸå§‹ç‰ˆæœ¬ | React Query ç‰ˆæœ¬ | å‡å°‘  |
| -------- | -------- | ---------------- | ----- |
| é˜²é‡é€»è¾‘ | 40è¡Œ     | 0è¡Œ              | -100% |
| çŠ¶æ€ç®¡ç† | 140è¡Œ    | 60è¡Œ             | -57%  |
| æ€»ä»£ç é‡ | 506è¡Œ    | 405è¡Œ            | -20%  |

### åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½         | åŸå§‹ç‰ˆæœ¬       | React Query ç‰ˆæœ¬    |
| ------------ | -------------- | ------------------- |
| é˜²é‡å¤è¯·æ±‚   | âœ… æ‰‹åŠ¨ç¼“å­˜key | âœ… è‡ªåŠ¨ (queryKey)  |
| å…¨å±€ç¼“å­˜     | âŒ             | âœ…                  |
| å¹¶å‘è¯·æ±‚ä¼˜åŒ– | âŒ             | âœ…                  |
| è‡ªåŠ¨é‡è¯•     | âŒ             | âœ…                  |
| ç¼“å­˜æ—¶é—´æ§åˆ¶ | âŒ             | âœ… staleTime/gcTime |
| DevTools     | âŒ             | âœ…                  |

---

## ğŸ§ª éªŒè¯æ­¥éª¤

### 1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
pnpm dev
# è®¿é—®: https://dev-ep5.gaodun.com:8667/
```

### 2. æµ‹è¯•è·¯å¾„

è®¿é—®é¢„æµ‹åˆ†é¡µé¢:

```
/project/{projectId}/predict-score?subjectId={subjectId}
```

### 3. å¯¹æ¯”æµ‹è¯•

1. æ‰“å¼€é¡µé¢ï¼Œè§‚å¯Ÿå³ä¸Šè§’åˆ‡æ¢å¼€å…³
2. é»˜è®¤ä½¿ç”¨"åŸå§‹ç‰ˆæœ¬"
3. åˆ‡æ¢åˆ°"React Query ç‰ˆæœ¬"
4. å¯¹æ¯”åŠŸèƒ½æ˜¯å¦ä¸€è‡´

### 4. åŠŸèƒ½éªŒè¯æ¸…å•

- [ ] è€ƒå­£åˆ—è¡¨åŠ è½½
- [ ] åˆ‡æ¢è€ƒå­£
- [ ] åˆ‡æ¢ç§‘ç›®
- [ ] è¯„ä¼°æ•°æ®å±•ç¤º
- [ ] è¶‹åŠ¿å›¾ 7å¤©/30å¤©åˆ‡æ¢
- [ ] æ¨¡è€ƒè®°å½•åŠ è½½
- [ ] åˆ·æ–°åŠŸèƒ½

### 5. æ€§èƒ½è§‚å¯Ÿ

æ‰“å¼€ React Query DevTools (å¼€å‘ç¯å¢ƒå·¦ä¸‹è§’):

- è§‚å¯ŸæŸ¥è¯¢çŠ¶æ€ (fresh/stale/inactive)
- éªŒè¯ç¼“å­˜å‘½ä¸­
- æ£€æŸ¥ç½‘ç»œè¯·æ±‚æ¬¡æ•°

---

## ğŸ“ˆ ä¸‹ä¸€æ­¥è®¡åˆ’

### é˜¶æ®µ 3: ç”Ÿäº§éªŒè¯ä¸æ¨å¹¿

#### 3.1 ç°åº¦å‘å¸ƒï¼ˆå»ºè®®ï¼‰

```typescript
// å¯é€šè¿‡ç‰¹æ€§å¼€å…³æ§åˆ¶
const USE_REACT_QUERY = window.localStorage.getItem('useReactQuery') === 'true';
```

#### 3.2 ç›‘æ§æŒ‡æ ‡

- [ ] é¡µé¢åŠ è½½æ—¶é—´
- [ ] ç½‘ç»œè¯·æ±‚æ•°é‡
- [ ] ç”¨æˆ·åé¦ˆ
- [ ] é”™è¯¯ç‡

#### 3.3 å›¢é˜ŸåŸ¹è®­

- [ ] ç¼–å†™æœ€ä½³å®è·µæ–‡æ¡£
- [ ] åˆ†äº«ä¼šè®²è§£æ ¸å¿ƒæ¦‚å¿µ
- [ ] Code Review è§„èŒƒæ›´æ–°

#### 3.4 æ¨å¹¿è·¯çº¿å›¾

**ä¼˜å…ˆçº§ 1** (é«˜æ”¶ç›Š):

- `src/pages/course/hooks/*` - è¯¾ç¨‹é¡µé¢å¤šTabåœºæ™¯
- `src/hooks/useCourseSeason.ts` - ç®€å•å…¸å‹æ¡ˆä¾‹

**ä¼˜å…ˆçº§ 2** (ä¸­ç­‰æ”¶ç›Š):

- `src/pages/study-plan/hooks/*` - å¤æ‚çŠ¶æ€ç¼–æ’
- `src/pages/inductive-live/hooks/*` - è½®è¯¢åœºæ™¯

**ä¼˜å…ˆçº§ 3** (ä¿æŒè§‚æœ›):

- ä¸€æ¬¡æ€§æ“ä½œçš„ async å‡½æ•°
- EventBus é©±åŠ¨çš„é€»è¾‘

---

## ğŸ”§ æœ€ä½³å®è·µè§„èŒƒ

### QueryKey å‘½åè§„èŒƒ

```typescript
// æ¨èæ ¼å¼ï¼š[åŸŸ, å­åŸŸ, ...å‚æ•°]
['predictScore', 'assessment', projectId, subjectId, seasonId][('course', 'syllabus', courseId, syllabusId)][('user', 'profile', userId)];
```

### staleTime é…ç½®å»ºè®®

```typescript
// é¢‘ç¹å˜åŒ–çš„æ•°æ®
staleTime: 1 * 60 * 1000; // 1åˆ†é’Ÿ

// ä¸­ç­‰é¢‘ç‡æ•°æ®
staleTime: 5 * 60 * 1000; // 5åˆ†é’Ÿ

// ç¨³å®šé…ç½®æ•°æ®
staleTime: 10 * 60 * 1000; // 10åˆ†é’Ÿ

// å‡ ä¹ä¸å˜çš„æ•°æ®
staleTime: 30 * 60 * 1000; // 30åˆ†é’Ÿ
```

### enabled ä½¿ç”¨åœºæ™¯

```typescript
// âœ… ä¾èµ–å…¶ä»–æŸ¥è¯¢çš„ç»“æœ
enabled: !!userId && !!courseId;

// âœ… æ¡ä»¶æ€§åŠ è½½
enabled: isTabActive;

// âœ… ç”¨æˆ·æƒé™æ§åˆ¶
enabled: hasPermission;
```

### å¤±æ•ˆç­–ç•¥

```typescript
// ç²¾ç¡®å¤±æ•ˆ
queryClient.invalidateQueries({
    queryKey: ['predictScore', 'assessment', projectId],
});

// æ¨¡ç³Šå¤±æ•ˆï¼ˆå¤±æ•ˆæ‰€æœ‰åŒ¹é…çš„ï¼‰
queryClient.invalidateQueries({
    queryKey: ['predictScore'],
});

// ç«‹å³é‡æ–°è·å–
queryClient.invalidateQueries({
    queryKey: ['predictScore', 'assessment'],
    refetchType: 'active',
});
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¸ç°æœ‰ http å·¥å…·çš„é›†æˆ

å½“å‰å®ç°å·²é€‚é…é¡¹ç›®çš„ `src/utils/http.ts`:

- âœ… å­—æ®µè‡ªåŠ¨è½¬æ¢ (é©¼å³° â†” ä¸‹åˆ’çº¿)
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†
- âœ… ç™»å½•å¤±æ•ˆè·³è½¬

### 2. ä¸ ahooks çš„é…åˆ

ä¸¤è€…å¯å…±å­˜:

- React Query: æ•°æ®è¯·æ±‚å±‚
- ahooks: UI äº¤äº’å±‚ (useMemoizedFn, useLockFn ç­‰)

### 3. æ€§èƒ½è€ƒè™‘

- é¿å…è¿‡åº¦ç»†ç²’åº¦çš„æŸ¥è¯¢æ‹†åˆ†
- åˆç†è®¾ç½® staleTime é¿å…è¿‡åº¦è¯·æ±‚
- ä½¿ç”¨ select é€‰é¡¹å‡å°‘ä¸å¿…è¦çš„é‡æ¸²æŸ“

---

## ğŸ“š å‚è€ƒèµ„æº

- [React Query å®˜æ–¹æ–‡æ¡£](https://tanstack.com/query/latest)
- [é¡¹ç›® Http å·¥å…·](../src/utils/http.ts)
- [åŸå§‹ Hook](../src/pages/predict-score/hooks/usePredictScore.tsx)
- [æ–°ç‰ˆ Hook](../src/pages/predict-score/hooks/usePredictScoreWithRQ.tsx)

---

## ğŸ¤ è´¡çŒ®ä¸åé¦ˆ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š

1. æäº¤ Issue
2. è”ç³»æŠ€æœ¯è´Ÿè´£äºº
3. åœ¨å›¢é˜Ÿä¼šè®®ä¸Šè®¨è®º

---

**æ›´æ–°æ—¶é—´**: 2025-10-15
**ç»´æŠ¤äºº**: å¼€å‘å›¢é˜Ÿ
